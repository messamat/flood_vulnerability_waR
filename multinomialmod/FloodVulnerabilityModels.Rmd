---
title: "Floodrisk and race in Washington"
author: "Ailene Ettinger, ailene.ettinger@tnc.org"
date: "2/3/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Question
Are there racial inequities in floodrisk in Washington state?


## Approach
Mathis has pulled together an enormous amount of work pulling together floodrisk and census data to get parcel-level race probabilites for the entire state of Washington (summarized in the README/technical document). He has already made a great story board, and figures as well. 

I am helping with the statistical models and moving the writing along.

## Statistical models
Data are grouped into nested levels of blocks, block groups, tracts, counties, and states. Socioeceonomic level exist only at the tract level. We have race (probability) at the parcel level.

We fit a multinomial mixed model with the following variables:
-Response: Race (parcel level), multinomial distribution
-Predictor: Flood Status, at the block level
-Random effect: county

We fit a multinomial logit model, in which we assume that the log-odds of each response (proportion of people in each race category) follows a linear model:
$$\eta_{i,j} = log (\pi_{i,j}/ \pi_{i,J}) = \alpha_{county[i]} + \beta_{flood}  x_{i} + \epsilon_{i}$$   
$$
\epsilon \sim N(0,\sigma^2_y)
$$
$$
\alpha_{county[i]} \sim N(\mu_{\alpha},\sigma^2_{\alpha})
$$
where $\eta$ is race in parcel _i_, $\alpha_{county[i]}$ is the county-specific intercept for race _j_, and _x_ is flooded status (0,1) of parcel _i_.
     
We implement the model in Stan via the brms package. 

I'm not sure which model structures we ideally want:

1) Random intercept (as shown in the equation, allowing for mean differences in floodrisk by county, but assuming the effect of floodrisk to be consistent across counties) 
  brms: mod <- brm (race ~ floodrisk + (1|county),
           data=wadat, family="multninomial",
           prior=c(set_prior ("normal (0, 1)")))
           
or 

2) Random slopes and intercepts (allowing for mean differences in floodrisk by county and allowing the effect of floodrisk on race to vary across counties). 
  brms: mod <- brm (race ~ floodrisk + (floodrisk|county),
           data=wadat, family=multinomial(),
           prior=c(set_prior ("normal (0, 1)")))
## Progress
I fit a single level version of the model to a single county and for 5 counties. The multi-level version is currently running on the 5-county subset. It takes forever currently so I need to get it to run more efficiently before fitting to the full dataset (structure of the random effects, adding priors) to help it run more efficiently. 

The single level model fits well 

![](figures/5counties_modplot.PNG)

It suggests that as floodrisk increases, the probability of whites inhabiting a parcel increases and the probability of hispanics increases. 

![](figures/5counties_condeff_noprior.png)


## Next Steps

1) Fit multi-level model with county (using reduced dataset)
2) Fit multi-level model with county (using full dataset)
3) Outline/writing


           
## Notes and Resources
Helpful links and code:

https://cran.r-project.org/web/packages/brms/vignettes/brms_multivariate.html

https://stackoverflow.com/questions/21082396/multinomial-logistic-multilevel-models-in-r


https://data.princeton.edu/wws509/notes/c6s2



