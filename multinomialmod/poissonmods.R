#Code by Ailene, ailene.ettinger@tnc.org
##Code by Ailene, ailene.ettinger@tnc.org
#Started March 2020
#Goal is to understand racial inequities in flood risk in Washington State
#Non Bayesian hierarchical poisson model via lme4
#housekeeping

rm(list=ls()) 
options(stringsAsFactors = FALSE)

library(sf)
library(data.table)
library(brms)
library(reshape)
library(lme4)
rootdir<-"C:/Users/ailene.ettinger/Box/floodrisk/flood_vulnerability/flood_vulnerability"
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
gdb <- 'flood_risk.gdb'
setwd(resdir)
p_attri <- st_read(dsn=gdb,layer="parcel_blocks_fill_flood_attri")#takes a long time to run!
p_attri <- setDT(p_attri)
p_attri <- p_attri[FEMAFloodStatus == 1 & is.na(FEMAStudyStatus), FEMAFloodStatus := 0]
p_attri <- p_attri[is.na(FEMAStudyStatus), FEMAStudyStatus := 0]

#To get county-unique code
p_attri[, county := as.factor(substr(GEOID10_t, 1, 5))]

#The columns that you want (and subset so that it only includes parcels with population that includes private owner's last name information - last_pop)
#PARCELPOP is the total pop in that parcel estimated by downscaling the census and the _BISG race probabilities are average probability distributions across all inhabitants of parcel (e.g. in the case of a condo building with lots of owners)

p_attri_subcol <- p_attri[last_pop>0, .(PolyID, FloodStatus, county,PARCELPOP, last_pop, white_BISG, black_BISG, hisp_BISG, asi_BISG, oth_BISG)]

# head(p_attri)
# head(p_attri_subcol)
# unique(round(p_attri_subcol$white_BISG, digits=1))
# hist(p_attri_subcol$white_BISG)
# hist(p_attri_subcol$black_BISG)
#hist(p_attri_subcol$FloodStatus)
#range(p_attri_subcol$PARCELPOP)


#p_attri_subcol<-p_attri_subcol[p_attri_subcol$parcelpop.int>0,]#pop must be greater than 0...

#Try limiting to just one county or a few counties to try to get model running? Trouble shooting is taking a while...
unique(p_attri_subcol$county)#39 levels
p_53001<-p_attri_subcol[p_attri_subcol$county==53001,]

p_5count<-p_attri_subcol[p_attri_subcol$county==53001|p_attri_subcol$county==53003|p_attri_subcol$county==53005|p_attri_subcol$county==53047|p_attri_subcol$county==53019,]
dim(p_5count)#72706    10
tapply(p_attri_subcol$PARCELPOP,list(p_attri_subcol$county),length)
#Convert proportions to integers


#d<-as.data.frame(p_53001)#single county test dataset
dwide<-as.data.frame(p_attri_subcol)#whole state dataset
#will need to remove 53031 perhaps- only 5 rows of data. other counties?
#tapply(d$PARCELPOP,list(d$county),length)
#remove 53065, 53075, 53031, 53015, 53041, 53055 (is.na and <100)
#Convert from wide format to long format
d <- reshape(dwide, direction = "long", varying = list(colnames(dwide)[6:10]),v.names = "prop", idvar = "PolyID", times = c("white","black","hisp","asi","oth"),timevar= "race")
d<-d[order(d$PolyID),]
head(d)
d$numb<-as.integer(d$prop*d$last_pop)

d$parcelpop.int<-as.integer(d$last_pop)
d<-d[d$parcelpop.int>0,]#pop must be greater than 0...

head(d)
tail(d)
dim(d)
d$county<-factor(d$county)#36 levels 
d$PolyID<-factor(d$PolyID)

fit<- glmer(numb~ FloodStatus * race + (1| PolyID) + (1|county), offset=log(parcelpop.int),data = d, family = poisson)#includes flood status, runs very slowly...seeing seeing how long it will take for the full dataset to run!


#dim(d)#1683683 rows
#the below crashes R every time i try to run it!