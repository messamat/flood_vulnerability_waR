
#housekeeping

rm(list=ls()) 
options(stringsAsFactors = FALSE)

library(sf)
library(data.table)
library(brms)
rootdir<-"C:/Users/ailene.ettinger/Box/floodrisk/flood_vulnerability/flood_vulnerability"
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
gdb <- 'flood_risk.gdb'
setwd(resdir)
p_attri <- st_read(dsn=gdb,layer="parcel_blocks_fill_flood_attri")#takes a long time to run!
p_attri <- setDT(p_attri)
p_attri <- p_attri[FEMAFloodStatus == 1 & is.na(FEMAStudyStatus), FEMAFloodStatus := 0]
p_attri <- p_attri[is.na(FEMAStudyStatus), FEMAStudyStatus := 0]

#To get county-unique code
p_attri[, county := as.factor(substr(GEOID10_t, 1, 5))]

#The columns that you want (and subset so that it only includes parcels with population that includes private owner's last name information - last_pop)
#PARCELPOP is the total pop in that parcel estimated by downscaling the census and the _BISG race probabilities are average probability distributions across all inhabitants of parcel (e.g. in the case of a condo building with lots of owners)

p_attri_subcol <- p_attri[last_pop>0, .(PolyID, FloodStatus, county,PARCELPOP, last_pop, white_BISG, black_BISG, hisp_BISG, asi_BISG, oth_BISG)]

# head(p_attri)
# head(p_attri_subcol)
# unique(round(p_attri_subcol$white_BISG, digits=1))
# hist(p_attri_subcol$white_BISG)
# hist(p_attri_subcol$black_BISG)
#hist(p_attri_subcol$FloodStatus)
#range(p_attri_subcol$PARCELPOP)


#p_attri_subcol<-p_attri_subcol[p_attri_subcol$parcelpop.int>0,]#pop must be greater than 0...

#Try limiting to just one county or a few counties to try to get model running? Trouble shooting is taking a while...
unique(p_attri_subcol$county)#39 levels
p_53001<-p_attri_subcol[p_attri_subcol$county==53001,]

p_5count<-p_attri_subcol[p_attri_subcol$county==53001|p_attri_subcol$county==53003|p_attri_subcol$county==53005|p_attri_subcol$county==53047|p_attri_subcol$county==53019,]
dim(p_5count)#72706    10
tapply(p_attri_subcol$PARCELPOP,list(p_attri_subcol$county),length)
#Convert proportions to integers
#will need to remove 53031 perhaps- only 5 rows of data. other counties?
tapply(d$PARCELPOP,list(d$county),length)
#remove 53065, 53075, 53031, 53015, 53041, 53055 (is.na and <100)


#d<-as.data.frame(p_53001)#single county test dataset
d<-as.data.frame(p_attri_subcol)#whole state dataset
d<-as.data.frame(p_5count)#picked 5 counties
white_int<-as.integer(d$white_BISG*d$PARCELPOP)
black_int<-as.integer(d$black_BISG*d$PARCELPOP)
hisp_int<-as.integer(d$hisp_BISG*d$PARCELPOP)
asi_int<-as.integer(d$asi_BISG*d$PARCELPOP)
oth_int<-as.integer(d$oth_BISG*d$PARCELPOP)
d$parcelpop.int<-as.integer(white_int+black_int+hisp_int+asi_int+oth_int)
d$y <- with(d, cbind(white_int,black_int, hisp_int,asi_int,oth_int))
head(d)
tail(d)
dim(d)
d<-d[d$parcelpop.int>0,]#pop must be greater than 0...
#First fit model without county as a level:
#mod <- brm(bf(y | trials(parcelpop.int)  ~ 1), data = d, 
#           family = multinomial())#intercept only model- just to see if it fits! it does! takes about 8 minutes for one county...

mod2 <- brm(bf(y | trials(parcelpop.int)  ~ FloodStatus), data = d, 
            family = multinomial())#includes flood status, runs very slowly...seeing seeing how long it will take for the full dataset to run!
#This takes a very long time...4766.48 seconds for  one chain. 
#model has many divergent transitions and other issues. likely not a lot of information for some races...this may be a problem...
summary(mod2)
conditional_effects(mod2, categorical=TRUE)
plot(mod2)
#Next try to fit to whole dataset, but with priors- hopefully it won't take so long!
# dim(d)# 1761539      10
# mod3 <- brm(bf(y | trials(parcelpop.int)  ~ FloodStatus), data = d, 
#             family = multinomial(),chains=2, iter=1000, warmup=500,
#             prior=c(set_prior ("normal (0, 1)")))
# 

# conditional_effects(mod3, categorical=TRUE)


#Next try to fit to whole dataset with random effect of county

mod3 <- brm(bf(y | trials(parcelpop.int)  ~ FloodStatus + (1|county)), data = d, 
            family = multinomial(),iter=500, chains=2,
            prior=c(set_prior ("normal (0, 1)")))


plot(mod3)
conditional_effects(mod3, categorical=TRUE)
summary(mod3)

mod4 <- brm(bf(y | trials(parcelpop.int)  ~ FloodStatus + (FloodStatus|county)), data = d, 
            family = multinomial(),iter=500, chains=2,
            prior=c(set_prior ("normal (0, 2)")))


plot(mod4)
conditional_effects(mod4, categorical=TRUE)
summary(mod4)

#(1 | ID1 | state) + (1 | ID2 | state:county) + (1 | ID3 | state:county:zip)

#Questions: Should we:
# 1) Change Flood Status to probability of flooding?
#Need to try adding priors to make this run faster- prior=c(set_prior ("normal (0, 8)")))
#also, nchains= 4
ex.prior <- c(prior_string("normal(0,3)", class="b"))
fit <- brm(
  formula= GS ~ IS + SS + (1|School),
  family= categorical (link="logit"),
  prior= ex.prior,
  data= pdata,
  cores=3,
  control = list(adapt_delta = 0.9)
)


####Simulating data to test the model out

#simulate some data to test a model
N <- 15
flooddat <- data.frame(
  y1 = rbinom(N, 10, 0.3), 
  y2 = rbinom(N, 10, 0.3),
  y3 = rbinom(N, 10, 0.6), #higher risk of floofing
  x = rnorm(N)
)

flooddat$y <- with(flooddat, cbind(y1, y2, y3))
flooddat$size <- with(flooddat, y1 + y2 + y3)
flooddat$status<-1
nonflooddat <- data.frame(
  y1 = rbinom(N, 10, 0.3), 
  y2 = rbinom(N, 10, 0.3), 
  y3 = rbinom(N, 10, 0.3), 
  x = rnorm(N)
)
nonflooddat$y <- with(nonflooddat, cbind(y1, y2, y3))
nonflooddat$size <- with(nonflooddat, y1 + y2 + y3)
nonflooddat$status<-0

#dat<-flooddat
dat<-rbind(flooddat,nonflooddat)
# prior <- prior(normal(0, 10), "b", dpar = muy2) +
#   prior(cauchy(0, 1), "Intercept") +
#   prior(normal(0, 2), "Intercept", dpar = muy3)
fit <- brm(bf(y | trials(size)  ~ 1, muy2 ~ x), data = dat, 
           family = multinomial(), prior = prior)
summary(fit)
fit2 <- brm(bf(y | trials(size)  ~ 1, muy2 ~ x), data = dat, 
            family = multinomial(), prior=c(set_prior ("normal (0, 8)")))
summary(fit2)
fit3 <- brm(bf(y | trials(size)  ~ x), data = dat, 
            family = multinomial(), prior=c(set_prior ("normal (0, 8)")))

summary(fit3)
fit4 <- brm(bf(y | trials(size)  ~ status), data = dat, 
            family = multinomial(), prior=c(set_prior ("normal (0, 8)")))
summary(fit4)
conditional_effects(fit4, categorical=TRUE)
p_attri_subcol<-as.data.frame(p_attri_subcol)