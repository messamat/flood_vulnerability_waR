library(sf)
library(data.table)
library(ggplot2)
library(ggrepel)
library(stringr)
library(hrbrthemes)

if (grepl('results', getwd())) {
  rootdir =  "C:/Mathis/ICSL/flood_vulnerability"
} else{
  rootdir = gsub("/src.*","",getwd())
}
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
setwd(resdir)

#----------------------------------- Import data ------------------------------------------------
gdb <- 'flood_risk.gdb'
#Read parcel-level data 
p_attri <- st_read(dsn=gdb,layer="parcel_blocks_fill_flood_attri")
p_attri <- setDT(p_attri)
#Read census block-level analysis data
b_attri <- st_read(dsn=gdb,layer="blockurbanflood_diss")
b_attri <- setDT(b_attri)
#Read census trast-level data
t_attri <- st_read(dsn=gdb, layer="tracts_floodfinal")
t_attri <- setDT(t_attri)
#Read block-group census data
bg <- st_read(file.path(datadir, 'TIGER2017/2010_ACS_5YR_BG_53_WASHINGTON.gdb'), layer = 'ACS_10_5YR_BG_53_WASHINGTON')
bg <- setDT(p_attri)
#Read parcel-FEMA intersection data
pFEMA_inters <- st_read(dsn=gdb, layer='parcels_FEMAdiss_inters')
pFEMA_inters <- setDT(pFEMA_inters) 

colnames(p_attri)

#----------------------------------- Results analysis ------------------------------------------------
#Total number of people
p_attri[,sum(PARCELPOP, na.rm=T)]
b_attri[,sum(POP10, na.rm=T)]
#Number of people living within flood zone as predicted with FEMA flood hazard data at census block level
b_attri[,sum(FEMAPOP_B, na.rm=T)]
#Number of people living within flood zone as predicted with FEMA flood hazard data at parcel level
p_attri[,sum(FEMApop, na.rm=T)]
#Number of people living within flood zone as predicted with FATHOM flood hazard data at census block level
b_attri[,sum(FLOODPOP_B, na.rm=T)]
#Number of people living within flood zone as predicted with FATHOM flood hazard data at parcel level
p_attri[,sum(floodpop, na.rm=T)]

#------------- Histogram of total and flood percentage by race + flood ratio, at tract level -----------------------
t_attri_BISGmelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                         measure.vars = grep('BISG_per', colnames(t_attri), value=T))
t_attri_BISGmelt[,category := '% of total population']

t_attri_BISGfloodmelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                              measure.vars = grep('BISG_floodper', colnames(t_attri), value=T))
t_attri_BISGfloodmelt[,`:=`(category = '% of population in flood zone',
                            variable = gsub('flood', "", variable))]
t_attri_BISG <- rbind(t_attri_BISGmelt, t_attri_BISGfloodmelt)

facet_names1 <- c(
  `white_BISG_per` = "Non-hispanic white population",
  `black_BISG_per` = "Non-hispanic black population",
  `hisp_BISG_per` = "Hispanic population",
  `asi_BISG_per` = "Asian population"
)

ggplot(t_attri_BISG[(variable != c('oth_BISG_per')),]) + 
  geom_histogram(aes(x=value, y = stat(count / sum(count)), fill=category), alpha=1/2, position='identity') +
  scale_x_percent(name = '') + 
  scale_y_percent(name = 'Percent of census tracts') + 
  scale_fill_manual(values = c('#7570b3', '#d95f02'), labels = function(x) str_wrap(x, width = 40)) +
  facet_wrap(~ variable, ncol = 1, scales = "free_y", labeller = as_labeller(facet_names1)) + 
  theme_ipsum_rc() + 
  theme(legend.title = element_blank(),
        legend.position="bottom")


t_attri_BISGratiomelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                              measure.vars = grep('BISG_floodratio', colnames(t_attri), value=T))
facet_names2 <- c(
  `white_BISG_floodratio` = "Non-hispanic white population",
  `black_BISG_floodratio` = "Non-hispanic black population",
  `hisp_BISG_floodratio` = "Hispanic population",
  `asi_BISG_floodratio` = "Asian population"
)

t_attri_BISGratiomelt[, category := ifelse(value<=1, 'negative', 'positive')]

#------------- Violin of total and flood percentage by race + flood ratio, at tract level -----------------------
leglabels1 <- c("Non-hispanic white population",
              "Non-hispanic black population",
              "Hispanic population",
              "Asian population")
ggplot(t_attri_BISGratiomelt[variable != 'oth_BISG_floodratio',],
       aes(x=variable, y=value, fill=variable, color=variable)) +
  geom_jitter(height = 0, width = 0.1, alpha=1/20, color='black') +
  geom_violin(alpha=1/1.5, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_hline(yintercept=1) + 
  scale_x_discrete(name = '', labels= str_wrap(leglabels, width=17)) + 
  scale_y_continuous(name = 'Flood risk representativity ratio',
                     limits=c(0,10), breaks = c(0,0.2,0.5,0.8,1,1.25,1.5,2,5, 10)) + 
  scale_fill_discrete(name = 'Flood risk representativity ratio', labels= leglabels) + 
  scale_color_discrete(name = 'Flood risk representativity ratio', labels= leglabels) +
  #scale_y_sqrt(breaks = c(0,0.1,0.2,0.5,1,1.5,2,5,10,20,40)) + 
  theme_ipsum_rc() +
  theme(panel.grid.minor = element_blank(),
        legend.position = 'None')

#------------- Lollipop graph of total and flood percentage by race x models x parcel vs. block, at state level -----------------------
#Pre-process parcel data
t_attri_ratiomelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                              measure.vars = grep('_floodratio', colnames(t_attri), value=T))

wa_stats <- p_attri[, c(white_BISGper = sum(white_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                       white_BISGfloodper = sum(white_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                       white_BISGFEMAper = sum(white_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T),
                       black_BISGper = sum(black_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                       black_BISGfloodper = sum(black_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                       black_BISGFEMAper = sum(black_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T),
                       hisp_BISGper = sum(hisp_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                       hisp_BISGfloodper = sum(hisp_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                       hisp_BISGFEMAper = sum(hisp_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T),
                       asi_BISGper = sum(asi_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                       asi_BISGfloodper = sum(asi_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                       asi_BISGFEMAper = sum(asi_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T)),]

wastats_format <- data.table(wastats, 
                             race = gsub('_BISG.*', '', names(wastats)), 
                             dat = gsub('(.*_BISG)', '', names(wastats)))
wastats_format[, dat := factor(dat, 
                               levels=c('per', 'floodper', 'FEMAper'))]
wastats_format[,`:=`(segmin = min(wastats),
                     segmax = max(wastats)), by = race]

#Pre-process block data
wa_statsb <- 

legtitle <- ''
leglabels2 <- c('In total', 'Living in flood zone (FATHOM data)','Living in flood zone (FEMA data)')
ggplot(wastats_format) +
  geom_segment( aes(x=segmin, xend=segmax, y=race, yend=race), color='black') +
  geom_point(aes(x=wastats, y=race, color=dat, shape=dat), size=3) +
  geom_text_repel(aes(x=wastats, y=race, label=paste(round(100*wastats,0),'%'), color=dat), 
            vjust = 2, angle=0) +
  scale_x_percent(name='Percentage of the Washington state population', limits=c(0,0.81), expand=c(0,0)) +
  scale_y_discrete(name = 'Race-Ethnicity', 
                   labels= gsub('\\s*population\\s*', '', as.character(leglabels1))[c(4,2,3,1)]) +
  scale_color_manual(name = legtitle, labels= leglabels2, values = c('#33a02c', '#1f78b4', '#7570b3')) +
  scale_shape(name = legtitle, labels= leglabels2) + 
  theme_ipsum_rc() +
  theme(panel.border = element_blank(),
        legend.position = c(0.65,0.20))



#Histogram of population living flood zone for block vs parcel and FATHOM vs FEMA (analyzed at block level)
#For each race (based on BISG), compare urban vs rural flood ratio
#Analyze Venn diagram of flooded population FATHOM and FEMA showing 



