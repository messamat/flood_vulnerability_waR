library(sf)
library(data.table)
library(plyr)
library(ggplot2)
library(gridExtra)
library(ggrepel)
library(stringr)
library(extrafont)
library(hrbrthemes)
library(VennDiagram)

windowsFonts("Arial" = windowsFont("Arial"))

if (grepl('results', getwd())) {
  rootdir =  "C:/Mathis/ICSL/flood_vulnerability"
} else{
  rootdir = gsub("/src.*","",getwd())
}
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
setwd(resdir)

#----------------------------------- Import data ------------------------------------------------
gdb <- 'flood_risk.gdb'
#Read parcel-level data 
p_attri <- st_read(dsn=gdb,layer="parcel_blocks_fill_flood_attri")
p_attri <- setDT(p_attri)
#Read census block-level analysis data
b_attri <- st_read(dsn=gdb,layer="blockurbanflood_diss")
b_attri <- setDT(b_attri)
#Read census trast-level data
t_attri <- st_read(dsn=gdb, layer="tracts_floodfinal")
t_attri <- setDT(t_attri)
#Read block-group census data
bg <- st_read(file.path(datadir, 'TIGER2017/2010_ACS_5YR_BG_53_WASHINGTON.gdb'), layer = 'ACS_10_5YR_BG_53_WASHINGTON')

#----------------------------------- Results analysis ------------------------------------------------
#Total number of people
p_attri[,sum(PARCELPOP, na.rm=T)]
b_attri[,sum(POP10, na.rm=T)]
#Number of people living within flood zone as predicted with FEMA flood hazard data at census block level
b_attri[,sum(FEMAPOP_B, na.rm=T)]
#Number of people living within flood zone as predicted with FEMA flood hazard data at parcel level
p_attri[,sum(FEMApop, na.rm=T)]
#Number of people living within flood zone as predicted with FATHOM flood hazard data at census block level
b_attri[,sum(FLOODPOP_B, na.rm=T)]
#Number of people living within flood zone as predicted with FATHOM flood hazard data at parcel level
p_attri[,sum(floodpop, na.rm=T)]

#------------- Histogram of total and flood percentage by race + flood ratio, at tract level -----------------------
t_attri_BISGmelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                         measure.vars = grep('BISG_per', colnames(t_attri), value=T))
t_attri_BISGmelt[,category := '% of total population']

t_attri_BISGfloodmelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                              measure.vars = grep('BISG_floodper', colnames(t_attri), value=T))
t_attri_BISGfloodmelt[,`:=`(category = '% of population in flood zone',
                            variable = gsub('flood', "", variable))]
t_attri_BISG <- rbind(t_attri_BISGmelt, t_attri_BISGfloodmelt)

facet_names1 <- c(
  `white_BISG_per` = "Non-hispanic white population",
  `hisp_BISG_per` = "Hispanic population",
  `black_BISG_per` = "Non-hispanic black population",
  `asi_BISG_per` = "Asian population"
)

ggplot(t_attri_BISG[(variable != c('oth_BISG_per')),]) + 
  geom_histogram(aes(x=value, y = stat(count / sum(count)), fill=category), alpha=1/2, position='identity') +
  scale_x_percent(name = '') + 
  scale_y_percent(name = 'Percent of census tracts') + 
  scale_fill_manual(values = c('#7570b3', '#d95f02'), labels = function(x) str_wrap(x, width = 40)) +
  facet_wrap(~ variable, ncol = 1, scales = "free_y", labeller = as_labeller(facet_names1)) + 
  theme_ipsum_rc() + 
  theme(legend.title = element_blank(),
        legend.position="bottom")


t_attri_BISGratiomelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                              measure.vars = grep('BISG_floodratio', colnames(t_attri), value=T))
facet_names2 <- c(
  `white_BISG_floodratio` = "Non-hispanic white population",
  `hisp_BISG_floodratio` = "Hispanic population",
  `black_BISG_floodratio` = "Non-hispanic black population",
  `asi_BISG_floodratio` = "Asian population"
)

t_attri_BISGratiomelt[, category := ifelse(value<=1, 'negative', 'positive')]

#------------- Violin of total and flood percentage by race + flood ratio, at tract level -----------------------
leglabels1 <- c("Non-hispanic white population",
                "Hispanic population",
                "Non-hispanic black population",
                "Asian population")
ggplot(t_attri_BISGratiomelt[variable != 'oth_BISG_floodratio',],
       aes(x=variable, y=value, fill=variable, color=variable)) +
  geom_jitter(height = 0, width = 0.1, alpha=1/20, color='black') +
  geom_violin(alpha=1/1.5, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_hline(yintercept=1) + 
  scale_x_discrete(name = '', labels= str_wrap(leglabels, width=17)) + 
  scale_y_continuous(name = 'Flood risk representativity ratio',
                     limits=c(0,10), breaks = c(0,0.2,0.5,0.8,1,1.25,1.5,2,5, 10)) + 
  scale_fill_discrete(name = 'Flood risk representativity ratio', labels= leglabels) + 
  scale_color_discrete(name = 'Flood risk representativity ratio', labels= leglabels) +
  #scale_y_sqrt(breaks = c(0,0.1,0.2,0.5,1,1.5,2,5,10,20,40)) + 
  theme_ipsum_rc() +
  theme(panel.grid.minor = element_blank(),
        legend.position = 'None')

#------------- Lollipop graph of total and flood percentage by race x models x parcel vs. block, at state level -----------------------
#Pre-process parcel-level data
t_attri_ratiomelt <- melt(t_attri[!is.na(SUM_last_popflood) & SUM_last_popflood>0,], id.vars = 'GEOID10_t', 
                          measure.vars = grep('_floodratio', colnames(t_attri), value=T))

p_attri[, urbanrural := ifelse(is.na(NAME10), 'rural', 'urban')] 

#Compute percentages for each race for a given model
summod <- function(dt, mod, ref, byc=NULL) {
  races <- unique(gsub(paste0('_',mod,'.*'), '',
                       grep(mod, colnames(dt), value=T)))
  ldply(races, function(race) {
    popcol = grep(paste0(race, '.*', mod, '.*_pop$'), colnames(p_attri), value=T)
    floodcol = grep(paste0(race, '.*', mod, '.*_popflood$'), colnames(p_attri), value=T)
    femacol = grep(paste0(race, '.*', mod, '.*_popFEMA$'), colnames(p_attri), value=T)
    varn <- c('per','floodper','FEMAper')
    statsdt <- p_attri[, c(sum(get(popcol), na.rm=T)/sum(get(paste0(ref, '_pop')), na.rm=T),
                           sum(get(floodcol), na.rm=T)/sum(get(paste0(ref, '_popflood')), na.rm=T),
                           sum(get(femacol), na.rm=T)/sum(get(paste0(ref, '_popfema')), na.rm=T)), by=byc]
    if (is.null(byc)) {
      statsdt <- data.table(bycol=rep('total', length(stats)), statsdt)
    }
    statsdt <- cbind(varn, statsdt, race, mod)
    paste0(race,'_',mod,'per')
    return(statsdt)
  })
}

wastats_tot <- summod(p_attri, mod='BISG', 'last')
setnames(wastats_tot, 2, 'urbanrural')
wastats <- rbind(wastats_tot, summod(p_attri, mod='BISG', 'last', byc='urbanrural'))
setnames(wastats, old='V1', new='stats')

wastats[, varn := factor(varn, levels=c('per', 'floodper', 'FEMAper'))]
wastats[,`:=`(segmin = min(stats), segmax = max(stats)), by = .(urbanrural, race)]
wastats$level <- 'parcel'

#Pre-process block-level data
wastats_t <- t_attri[, c(white_censusper = sum(DP0110011)/sum(DP0080001),
                         white_censusfloodper = sum(SUM_FLOODPOP_B*DP0110011/DP0080001, na.rm=T)/sum(SUM_FLOODPOP_B, na.rm=T),
                         white_censusFEMAper = sum(SUM_FEMAPOP_B*DP0110011/DP0080001, na.rm=T)/sum(SUM_FEMAPOP_B, na.rm=T),
                         black_censusper = sum(DP0110012)/sum(DP0080001),
                         black_censusfloodper = sum(SUM_FLOODPOP_B*DP0110012/DP0080001, na.rm=T)/sum(SUM_FLOODPOP_B, na.rm=T),
                         black_censusFEMAper = sum(SUM_FEMAPOP_B*DP0110012/DP0080001, na.rm=T)/sum(SUM_FEMAPOP_B, na.rm=T),
                         hisp_censusper = sum(DP0110002)/sum(DP0080001),
                         hisp_censusfloodper = sum(SUM_FLOODPOP_B*DP0110002/DP0080001, na.rm=T)/sum(SUM_FLOODPOP_B, na.rm=T),
                         hisp_censusFEMAper = sum(SUM_FEMAPOP_B*DP0110002/DP0080001, na.rm=T)/sum(SUM_FEMAPOP_B, na.rm=T),
                         asi_censusper = sum(DP0110014+ DP0110015)/sum(DP0080001),
                         asi_censusfloodper = sum(SUM_FLOODPOP_B*(DP0110014+DP0110015)/DP0080001, na.rm=T)/sum(SUM_FLOODPOP_B, na.rm=T),
                         asi_censusFEMAper = sum(SUM_FEMAPOP_B*(DP0110014+DP0110015)/DP0080001, na.rm=T)/sum(SUM_FEMAPOP_B, na.rm=T)),]
wastats_tformat <- data.table(stats = wastats_t, 
                              race = gsub('_census.*', '', names(wastats_t)), 
                              varn = gsub('(.*_census)', '', names(wastats_t)))
wastats_tformat[,`:=`(segmin = min(stats),
                      segmax = max(stats)), by = race]
wastats_tformat$level <- 'block'

wastats_join <- rbind(wastats, wastats_tformat, fill=TRUE)
wastats_join[, `:=`(varn = factor(varn, levels=c('per', 'floodper', 'FEMAper')),
                    race = factor(race, levels=unique(setorder(wastats_join[level == 'parcel',], stats)$race)))]
wastats_join$race


legtitle <- ''
leglabels2 <- c('In total', 'Living in flood zone (FATHOM data)','Living in flood zone (FEMA data)')
update_geom_font_defaults(family = "Arial Narrow", face = "plain",
                          size = 3.5, color = "#2b2b2b")

parcelblock_lollipop <- ggplot(wastats_join[urbanrural %in% c('total',NA) & race != 'oth',]) +
  geom_linerange( aes(x=race, ymin=segmin, ymax=segmax, group=level), 
                  color='black', position= position_dodge(width=0.5)) +
  geom_point(aes(x=race, y=stats, color=varn, shape=varn, group=level), 
             size=3, alpha=3/4, position= position_dodge(width=0.5)) +
  geom_text_repel(aes(x=race, y=stats, label=paste0(round(100*stats,0),'%'), color=varn, group=level), 
                  vjust = 0, angle=0, position= position_dodge(width=1),
                  max.iter=20000, direction="x", segment.alpha = 0, xlim = c(0,90)) +
  annotate('text', x = c(Inf, Inf), y = c(-Inf,-Inf), vjust = c(6.5,9), hjust = c(-0.12,-0.1),
           label=c('parcel-level assessment', 'block/tract-level assessment')) +
  scale_y_percent(name='Percentage of the Washington state population', limits=c(0,1), expand=c(0,0)) +
  scale_x_discrete(name = 'Race-Ethnicity',
                   labels= gsub('\\s*population\\s*', '', as.character(rev(leglabels1)))) +
  scale_color_manual(name = legtitle, labels= leglabels2, values = c('#8c510a', '#01665e', '#542788')) +
  scale_shape(name = legtitle, labels= leglabels2) + 
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(),
        legend.position = c(0.65,0.20),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.line = element_line(color='black'))

urbanrural_lollipop <-ggplot(wastats_join[level == 'parcel' & urbanrural %in% c('rural','urban'),]) +
  geom_linerange( aes(x=race, ymin=segmin, ymax=segmax, group=urbanrural), 
                  color='black', position= position_dodge(width=0.5)) +
  geom_point(aes(x=race, y=stats, color=varn, shape=varn, group=urbanrural), 
             size=3, alpha=3/4, position= position_dodge(width=0.5)) +
  geom_text_repel(aes(x=race, y=stats, label=paste0(round(100*stats,0),'%'), color=varn, group=urbanrural), 
                  vjust = 0, angle=0, position= position_dodge(width=1),
                  max.iter=20000, direction="x", segment.alpha = 0, xlim = c(0,90)) +
  annotate('text', x = c(Inf, Inf), y = c(-Inf,-Inf), vjust = c(6.5,9), hjust = c(-0.12,-0.1),
           label=c('Urban areas', 'Rural areas')) +
  scale_y_percent(name='Percentage of the Washington state population', limits=c(0,1), expand=c(0,0)) +
  scale_x_discrete(name = 'Race-Ethnicity',
                   labels= gsub('\\s*population\\s*', '', as.character(rev(leglabels1)))) +
  scale_color_manual(name = legtitle, labels= leglabels2, values = c('#8c510a', '#01665e', '#542788')) +
  scale_shape(name = legtitle, labels= leglabels2) + 
  coord_flip() +
  theme_bw() +
  theme(panel.border = element_blank(),
        legend.position = c(0.65,0.20),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        axis.line = element_line(color='black'))

grid.arrange(parcelblock_lollipop, urbanrural_lollipop)

#Histogram of population living in flood zone for block vs parcel and FATHOM vs FEMA (analyzed at tract level)

#------------- Correlate block-group real estate value to flood ratios --------------------------------------------------------------
# poverty status B17021e1
# median household income B19013e1
# owner-occupied housing units median value (B25077e1)
# ratio of income to poverty level in past 12 months (C17002e1)
# contract rent/with cash rent (B25056e2)
wastats_bg <- setDT(summod(p_attri, mod='BISG', 'last', byc='GEOID10_bg'))
setnames(wastats_bg, old='V1', new='stats')
wastats_bgj <- wastats_bg[setDT(as.data.frame(bg)[,c('GEOID10', 'B17021e1', 'B19013e1', 'B25077e1', 'C17002e1', 'B25056e2')]),
                         on= 'GEOID10_bg==GEOID10']
#######BUGGY: TO SOLVE ##############
#Compute average of state-standardized rent and house prise
wastats_bgj[, `:=`(housing_standardized = B25077e1/mean(B25077e1, na.rm = T),
                  rent_standardized = B25056e2/mean( B25056e2, na.rm = T))]
wastats_bgj[, real_standardized := (housing_standardized + rent_standardized)/2]


wastats_bgmelt <- melt(wastats_bgj, id.vars = colnames(wastats_bgj)[!grepl('BISG', colnames(wastats_bgj))],
                       measure.vars = grep('BISG', colnames(wastats_bgj), value=T))

castf <- as.formula(
  paste(
    paste(colnames(wastats_bgmelt)[!(colnames(wastats_bgmelt) %in% c('varn','value', 'variable'))], collapse = ' + '),
    '~ varn'))

wastats_bgcast <- dcast(wastats_bgmelt, castf, value.var = 'stats')
wastats_bgcast[, `:=`(floodratio = floodper/per,
                      FEMAratio = FEMAper/per)]

#Check correlation with percentage population of each race in block group
ggplot(wastats_bgcast, aes(x=per, y=floodratio)) + 
  geom_point(alpha=1/2) + 
  geom_smooth(color='red') +
  geom_quantile(quantiles=c(0.1, 0.25, 0.5, 0.75, 0.9), color='orange') +
  scale_y_log10() +
  facet_grid(~race) +
  theme_ipsum()

#Check correlation with median household income (B19013e1)
ggplot(wastats_bgcast, aes(x=B19013e1, y=floodratio)) + 
  geom_point(alpha=1/2) + 
  geom_smooth(color='red', method='lm') +
  geom_quantile(quantiles=c(0.1, 0.25, 0.5, 0.75, 0.9), color='orange') +
  geom_hline(yintercept=1, color='black') +
  scale_y_log10() +
  facet_grid(~race) +
  theme_classic()

#Check correlation with ratio of income to poverty level in past 12 months
ggplot(wastats_bgcast, aes(x=C17002e1, y=floodratio)) + 
  geom_point(alpha=1/2) + 
  geom_smooth(color='red', method='lm') +
  geom_quantile(quantiles=c(0.1, 0.25, 0.5, 0.75, 0.9), color='orange') +
  geom_hline(yintercept=1, color='black') +
  scale_y_log10() +
  facet_grid(~race) +
  theme_classic()

#Check correlation with real estate standardized index 
#(average of statewide-standardized rent and house prices)
ggplot(wastats_bgcast, aes(x=real_standardized, y=floodratio)) + 
  geom_point(alpha=1/2) + 
  geom_smooth(color='red', method='lm') +
  geom_quantile(quantiles=c(0.1, 0.25, 0.5, 0.75, 0.9), color='orange') +
  geom_hline(yintercept=1, color='black') +
  scale_y_log10() +
  facet_grid(~race) +
  theme_classic()

#------------- Venn diagram of flooded population FATHOM and FEMA showing total population and flood ratio for different races --------------------------------------------------------------
#Join pFEMA_inters with p_attri
wastats_bg <- p_attri[, .(white_BISGper = sum(white_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                          white_BISGfloodper = sum(white_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                          white_BISGFEMAper = sum(white_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T),
                          black_BISGper = sum(black_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                          black_BISGfloodper = sum(black_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                          black_BISGFEMAper = sum(black_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T),
                          hisp_BISGper = sum(hisp_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                          hisp_BISGfloodper = sum(hisp_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                          hisp_BISGFEMAper = sum(hisp_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T),
                          asi_BISGper = sum(asi_BISG_pop, na.rm=T)/sum(last_pop, na.rm=T),
                          asi_BISGfloodper = sum(asi_BISG_popflood, na.rm=T)/sum(last_popflood, na.rm=T),
                          asi_BISGFEMAper = sum(asi_BISG_popFEMA, na.rm=T)/sum(last_popfema, na.rm=T)),
                      by = .(FloodStatus, FEMAFloodStatus)]


#Build multiple logistic regression model (with random effects?) to predict whether in flood zone or not, including value of block group, race of landowner.



