library(foreign)
library(data.table)
library(sf)
library(ggplot2)
library(gridExtra)
library(mgcv)

if (grepl('results', getwd())) {
  rootdir =  "C:/Mathis/ICSL/flood_vulnerability"
} else{
  rootdir = gsub("/src.*","",getwd())
}
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
setwd(resdir)

#TO DO:
# - Test keeping only those names with same address 
# - Test keeping name only once within the same PolyID
# - Automatize table making of data inspection
# - Check PolyID duplicates with PARCELPOP > 0, see how to join them. 

#----------------------------------- Import data ------------------------------------------------
#Parcel-level race/ethnicity predictions - all models
parcel_pred <- read.csv('parcels_blocksfill_racepred.csv', 
                        colClasses= c('character', 'character', rep('numeric', 41), 'character', 'numeric',
                                      'character', rep('numeric', 6), 'character','character'))
parcel_predsub <- setDT(parcel_pred)[PARCELPOP>0 & !is.na(PARCELPOP),]
parcel_pred$censusmod_sum <- with(parcel_pred, api+black+hispanic+white)
#qplot(parcel_pred$censusmod_sum)

#Blockgroup-level race/ethnicity predictions - all models
bg_pred <- read.dbf('blockgroup_racepred.dbf')
bg_pred$censusmod_sum <- with(bg_pred, api+black+hispanic+white)
#qplot(bg_pred$censusmod_sum)
bg_pred <- bg_pred[bg_pred$PARCELPOP_>0,]
#str(bg_pred)

#Tract-level race/ethnicity predictions - all models
t_pred <- read.dbf('tract_racepred.dbf')
t_pred$censusmod_sum <- with(t_pred, api+black+hispanic+white)
#qplot(t_pred$censusmod_sum)
t_pred <- t_pred[t_pred$PARCELPOP_>0 & t_pred$white>0 & t_pred$censusmod_sum>0,]
#str(t_pred)

#Get county codes
WAparceldb <- file.path(datadir, 'WAParcel/StatewideParcels_v2012_e9.2_r1.3/StatewideParcels_v2012_e9.2_r1.3.gdb')
dataproviders <- st_read(dsn=WAparceldb,layer="DataProvider")

# #Taxroll record (after removal of duplicate TaxRollIDs) joined to name - UNCOMMENT ONLY IF NEEDED - MEMORY SUCK
# vulgdb <- 'flood_vulnerability.gdb'
# parcel_taxrollname <- st_read(dsn=vulgdb,layer="parcel_taxrollname")

#After examination, remove items and collect garbage

##############################################################################################################
##----------------------------------- Examine and format data ------------------------------------------------
##############################################################################################################
# #UNCOMMENT TO RE-ANALYZE
# ##----------- Assess number of parcels and population with race/ethnicity predictions ------------------------
# #Total number of parcel-blocks intersections
# parcel_pred <- setDT(parcel_pred)
# 
# #Total number of parcel-blocks intersections kept in spatial parcel database
# parcel_pred[!is.na(TAXROLLNUM),.N]
# #Total number of parcels in spatial database 
# parcel_pred[!is.na(TAXROLLNUM), uniqueN(PolyID)]
# #Total population in spatial parcel database
# parcel_predsub[,sum(PARCELPOP)]
# 
# #Total number of parcels with population
# parcel_predsub[, .N]
# parcel_predsub[, uniqueN(PolyID)]
# 
# #Total number of parcel-block intersections with population and a taxroll record
# parcel_predsub[TAXROLLNUM>0, .N]
# #Why TAXROLLNUM == 0?
# notaxroll <- parcel_predsub[TAXROLLNUM==0 | is.na(TAXROLLNUM),]
#   #Because not in taxroll record in the first place (e.g. Cowlitz, Stevens, etc.) - see flood_risk_WA_format.py l349
# countyname_notaxroll <- dataproviders[dataproviders$Abbreviation %in% c('Cowlitz', 'Lewis', 'Stevens', 'Jefferson', 'San Juan'),
#                                   'DataProviderID']
# county_notaxroll <- notaxroll[substr(PolyID,1,3) %in% countyname_notaxroll,] #93,465
#   #Because not a residential land use and so was not included 
#       #consider including by changing flood_risk_WA_format.py l353 to general taxroll database so as to include owner name
# notaxroll[!(substr(PolyID,1,3) %in% countyname_notaxroll) & PolyID %in% parcel_taxrollname$PolyID, .N] #48,624
#   #Because census block that does not intersect any parcel
# notaxroll[PolyID == ' ', .N] #2,674 Not NA.. will be changed to 99900000000+
#   #Because 0 or NA StateLandUseCD + no land owner name associated with parcel
# notaxroll_error <- notaxroll[!(substr(PolyID,1,3) %in% countyname_notaxroll) & 
#                                !(PolyID %in% parcel_taxrollname$PolyID) &
#                                PolyID != ' ',]
#   #Because erroneously deleted when looking at duplicate PolyIDs in taxroll record? Correct, check again?
# 
# #Total population living in a parcel with taxroll record
# parcel_predsub[TAXROLLNUM>0,sum(PARCELPOP)]
# 
# #Total number of parcel-block intersections with population, a taxroll record, and a name that could be analyzed
# parcel_predsub[TAXROLLNUM>0 & !is.na(TaxRollIDCount), .N]
# 
# ggplot(parcel_predsub[abs(TAXROLLNUM-TaxRollIDCount)>0 & !is.na(TaxRollIDCount),],
#        aes(x=TAXROLLNUM-TaxRollIDCount)) + geom_histogram() + scale_y_sqrt()
# morenames <- parcel_predsub[(TAXROLLNUM-TaxRollIDCount)<0 & !is.na(TaxRollIDCount),]
# #Not sure why some records have different number
# 
# #Population living in parcel with a name that could be analyzed
# parcel_predsub[TAXROLLNUM>0 & !is.na(TaxRollIDCount), sum(PARCELPOP)]
# 
# #Average percentage of taxroll records per parcel that had a name to analyze for race/ethnicity prediction
# parcel_predsub[TAXROLLNUM>0 & !is.na(TaxRollIDCount), 100*mean(TaxRollIDCount/TAXROLLNUM)]
# 
# #For each model, percentage of taxroll records and population that has name predictions
# parcel_predsub[!is.na(white), c(.N, sum(PARCELPOP))] 
# parcel_predsub[!is.na(pctwhite), c(.N, sum(PARCELPOP))] 
# parcel_predsub[!is.na(GreaterEuropean.WestEuropean.French_wikiln), c(.N, sum(PARCELPOP))] 
# parcel_predsub[!is.na(GreaterEuropean.WestEuropean.French), c(.N, sum(PARCELPOP))] 
# parcel_predsub[!is.na(nh_white), c(.N, sum(PARCELPOP))] 

#------- Summary statistics by block group
#Percentage of parcels with name prediction per block group
bg_namedat <- parcel_predsub[, .(lastpred = 100*length(.I[!is.na(white)])/.N,
                                 lastfirstpred = 100*length(.I[!is.na(nh_white)])/.N,
                                 census = 100*length(.I[!is.na(pctwhite)])/.N), 
                             by=GEOID10_bg] 
#Percentage of population with name prediction per block group                             
bg_namedatpop <- parcel_predsub[, .(lastpred_pop = 100*sum(.SD[!is.na(white), PARCELPOP])/sum(.SD[,PARCELPOP]),
                                 lastfirstpred_pop = 100*sum(.SD[!is.na(nh_white), PARCELPOP])/sum(.SD[,PARCELPOP]),
                                 census_pop = 100*sum(.SD[!is.na(pctwhite), PARCELPOP])/sum(.SD[,PARCELPOP])),
                             by=GEOID10_bg]

ggplot(melt(bg_namedatpop, id.vars='GEOID10_bg'), aes(value)) + 
  stat_ecdf(aes(color=variable), size=1.3) +
  scale_x_continuous(name='Population with race data within block group (%)', expand=c(0,0), breaks=seq(0,100,10)) + 
  scale_y_continuous(name='Cumulative proportion of block groups', expand=c(0,0), breaks=seq(0,1,0.1)) + 
  theme_bw()

#------- Summary statistics by tract
#Percentage of parcels with name prediction per tract
t_namedat <- parcel_predsub[, .(lastpred = 100*length(.I[!is.na(white)])/.N,
                                 lastfirstpred = 100*length(.I[!is.na(nh_white)])/.N,
                                 census = 100*length(.I[!is.na(pctwhite)])/.N), 
                             by=GEOID10_t] 
#Percentage of population with name prediction per tract                           
t_namedatpop <- parcel_predsub[, .(lastpred_pop = 100*sum(.SD[!is.na(white), PARCELPOP])/sum(.SD[,PARCELPOP]),
                                    lastfirstpred_pop = 100*sum(.SD[!is.na(nh_white), PARCELPOP])/sum(.SD[,PARCELPOP]),
                                    census_pop = 100*sum(.SD[!is.na(pctwhite), PARCELPOP])/sum(.SD[,PARCELPOP])),
                                by=GEOID10_t]

racepopcdf <- ggplot(melt(t_namedatpop, id.vars='GEOID10_t'), aes(value)) + 
  stat_ecdf(aes(color=variable), size=1.1, alpha=0.75) +
  #stat_ecdf(aes(y = 1 - ..y.., color=variable), stat='ecdf', size=1.3) +
  scale_x_reverse(name='Population with race data within tract (%)', limits=c(100,0), expand=c(0,0), breaks=seq(0,100,10)) + 
  scale_y_continuous(name='Cumulative proportion of tracts', expand=c(0,0), breaks=seq(0,1,0.1)) + 
  scale_color_manual(name= 'Race-name model type', values=c('#1b9e77','#d95f02','#7570b3'),
                       labels=c('Last name-only model', 'Last and first name model', 'Census model')) +
  theme_bw() + 
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        panel.grid.minor = element_blank())

png(file.path(figdir, 'tract_racepopmod_cdf.png'), height=5, width=8, units = 'in', res=400)
racepopcdf
dev.off()

t_namedatpop[,length(.I[lastpred_pop>70])/.N] #Percentage of census tracts with race data for > 70% of the population

##############################################################################################################
##----------------------------------- Analyze results ------------------------------------------------
##############################################################################################################
#-------------------------------------------------------------------------
#Compare parcel aggregated population to blockgroup population estimates
ggplot(bg_pred, aes(x=B02001e1, y=PARCELPOP_)) + 
  geom_point() + 
  geom_smooth()
summary(lm(B02001e1~PARCELPOP_, data=bg_pred))

#Compare parcel-aggregated population to tract population
ggplot(t_pred, aes(x=DP0080001, y=PARCELPOP_)) + 
  geom_point() + 
  geom_smooth()
max(with(t_pred, abs(DP0080001-PARCELPOP_)), na.rm=T)

#Only keep census tracts for which have race data for >80% of population
t_pred <- setDT(t_pred)[t_namedatpop, on=c(GEOID10='GEOID10_t')]
t_predsub <- t_pred[lastpred_pop>90,]  
##----------------------------------- Analyze census tract data ------------------------------------------------
#Check predictions for white population
t_predsub[, `:=`(census_whiteper = DP0090001/DP0080001,
                 census_blackper = DP0090002/DP0080001,
                 census_hispper = DP0110002/DP0080001,
                 census_apiper = (DP0090004+DP0090005)/DP0080001,
                 white_wikifull = British+EastEurope+Jewish+French+Germanic+Italian+Nordic,
                 white_wikiln = British_wi+EastEuro_1+Jewish_wik+French_wik+Germanic_w+Italian_wi+Nordic_wik,
                 black_wikifull = Africans+Muslim,
                 black_wikiln = Africans_w+Muslim_wik,
                 api_wikifull = EastAsian+Japanese+IndianSubC,
                 api_wikiln = EastAsian_+Japanese_w+IndianSu_1)
          ,]

gamplot <- function(dat, x, y, modname) {
  r2_label <- round(summary(mgcv::gam(formula(paste0(y,'~ s(',x,')')), data=dat))$dev.expl,2)
  lims <- c(min(min(dat[,get(x)], na.rm=T), min(dat[,get(y)], na.rm=T)),
            max(max(dat[,get(x)], na.rm=T), max(dat[,get(y)], na.rm=T)))
  ggplot(dat, aes_string(x, y)) + 
    geom_point() + 
    geom_smooth(method='gam') +
    geom_abline(slope=1, color='red') +
    ggtitle(bquote(paste(.(modname), ', ',R^2==~.(r2_label)))) + 
    coord_fixed(ratio=1) +
    scale_x_continuous(limits= lims, expand=c(0,0)) +
    scale_y_continuous(limits= lims, expand=c(0,0)) +
    #coord_trans(x='pow10', y='pow10') +
    theme_classic()
}

whitecens <- gamplot(t_predsub, 'white', 'census_whiteper', 'Last name census model') +
  labs(x = 'Predicted proportion of non-hispanic whites', y= 'Reported proportion of non-hispanic whites')
whitewikiln <- gamplot(t_predsub, 'white_wikiln', 'census_whiteper', 'Last name wikipedia model') +
  labs(x = 'Predicted proportion of non-hispanic whites', y= 'Reported proportion of non-hispanic whites')
whitewikifull <- gamplot(t_predsub, 'white_wikifull', 'census_whiteper', 'Full name wikipedia model') +
  labs(x = 'Predicted proportion of non-hispanic whites', y= 'Reported proportion of non-hispanic whites')
whiteflreg <- gamplot(t_predsub, 'nh_white', 'census_whiteper', 'Full name Florida registration model') +
  labs(x = 'Predicted proportion of non-hispanic whites', y= 'Reported proportion of non-hispanic whites')
grid.arrange(whitecens, whitewikiln, whitewikifull, whiteflreg)

blackcens <- gamplot(t_predsub, 'black', 'census_blackper', 'Last name census model') +
  labs(x = 'Predicted proportion of non-hispanic blacks', y= 'Reported proportion of non-hispanic blacks')
blackwikiln <- gamplot(t_predsub, 'black_wikiln' , 'census_blackper', 'Last name wikipedia model') +
  labs(x = 'Predicted proportion of non-hispanic blacks', y= 'Reported proportion of non-hispanic blacks')
blackwikifull <- gamplot(t_predsub, 'black_wikifull', 'census_blackper', 'Full name wikipedia model') +
  labs(x = 'Predicted proportion of non-hispanic blacks', y= 'Reported proportion of non-hispanic blacks')
blackflreg <- gamplot(t_predsub, 'nh_black', 'census_blackper', 'Full name Florida registration model') +
  labs(x = 'Predicted proportion of non-hispanic blacks', y= 'Reported proportion of non-hispanic blacks')
grid.arrange(blackcens, blackwikiln, blackwikifull, blackflreg)

hispcens <- gamplot(t_predsub, 'hispanic', 'census_hispper', 'Last name census model') +
  labs(x = 'Predicted proportion of hispanics', y= 'Reported proportion of hispanics')
hispwikiln <- gamplot(t_predsub, 'Hispanic_w' , 'census_hispper', 'Last name wikipedia model') +
  labs(x = 'Predicted proportion of hispanics', y= 'Reported proportion of hispanics')
hispwikifull <- gamplot(t_predsub, 'Hispanic_1', 'census_hispper', 'Full name wikipedia model') +
  labs(x = 'Predicted proportion of hispanics', y= 'Reported proportion of hispanics')
hispflreg <- gamplot(t_predsub, 'hispanic_f', 'census_hispper', 'Full name Florida registration model') +
  labs(x = 'Predicted proportion of hispanics', y= 'Reported proportion of hispanics')
grid.arrange(hispcens, hispwikiln, hispwikifull, hispflreg)

apicens <- gamplot(t_predsub, 'api', 'census_apiper', 'Last name census model') +
  labs(x = 'Predicted proportion of non-hispanic API', y= 'Reported proportion of non-hispanic API')
apiwikiln <- gamplot(t_predsub, 'api_wikiln' , 'census_apiper', 'Last name wikipedia model') +
  labs(x = 'Predicted proportion of non-hispanic API', y= 'Reported proportion of non-hispanic API')
apiwikifull <- gamplot(t_predsub, 'api_wikifull', 'census_apiper', 'Full name wikipedia model') +
  labs(x = 'Predicted proportion of non-hispanic API', y= 'Reported proportion of non-hispanic API')
apiflreg <- gamplot(t_predsub, 'asian', 'census_apiper', 'Full name Florida registration model') +
  labs(x = 'Predicted proportion of non-hispanic API', y= 'Reported proportion of non-hispanic API')
grid.arrange(apicens, apiwikiln, apiwikifull, apiflreg)


res <- residuals.gam(mgcv::gam(census_whiteper~white, data=t_predsub))
qplot(res)
qqnorm(res)
qqline(res)