packrat::status()

library(foreign)
library(feather)
library(fst)
library(data.table)
library(sf)
library(ggplot2)
library(gridExtra)
library(mgcv)
library(DescTools)
library(grDevices)
library(scales)
library(stringr)
library(rprojroot)

rootdir <- find_root(has_dir("src"))
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
gdb <- 'flood_risk.gdb'
setwd(resdir)

#----------------------------------- Import data ------------------------------------------------
#Parcel owner names
residindiv_filter <- read_feather('residindiv_filter.feather')

#Parcel-level race/ethnicity predictions - all models
p_pred <- read.fst('parcels_blocksfill_racepred.fst') %>% setDT
p_pred[, censusmod_sum := asi_BISG + black_BISG + hisp_BISG + oth_BISG + white_BISG]
#qplot(p_pred$censusmod_sum)

#Blockgroup-level race/ethnicity predictions - all models
bg_pred <- read.dbf('blockgroup_racepred.dbf') #does not include BISG model
setDT(bg_pred)[, censusmod_sum := api+white+black+hispanic] 
#qplot(bg_pred$censusmod_sum)
bg_pred <- bg_pred[bg_pred$PARCELPOP_>0,]
#str(bg_pred)

#Tract-level race/ethnicity predictions - all models
t_ethnicolrpred <- read.dbf('tract_racepred.dbf')
setDT(t_ethnicolrpred)[, censusmod_sum := api+black+hispanic+white]
#qplot(t_ethnicolrpred$censusmod_sum)
t_ethnicolrpred <- setDT(t_ethnicolrpred)[PARCELPOP_>0 & !is.na(PARCELPOP_) & white>0 & censusmod_sum>0,]
#str(t_pred)
#Add BISG predictions to tracts
t_BISGpred <- read_feather('tract_BISGpred.feather')
t_pred <- t_ethnicolrpred[setDT(t_BISGpred), on='GEOID10_t']
t_attri <- st_read(dsn=gdb, layer="tracts_floodfinal") %>% setDT

#Get county codes
WAparceldb <- file.path(datadir, 'WAParcel/StatewideParcels_v2012_e9.2_r1.3/StatewideParcels_v2012_e9.2_r1.3.gdb')
dataproviders <- st_read(dsn=WAparceldb,layer="DataProvider")

#Import SVI data
SVI <- read.csv(file.path(datadir, 'SVI/Washington_03242014.csv'))
SVI$FIPS <- as.factor(SVI$FIPS)

# #Taxroll record (after removal of duplicate TaxRollIDs) joined to name - UNCOMMENT ONLY IF NEEDED - MEMORY SUCK
# vulgdb <- 'flood_vulnerability.gdb'
# parcel_taxrollname <- st_read(dsn=vulgdb,layer="parcel_taxrollname")

#Buildings-parcel-flood intersection
#buildattri <- read.csv('buildings_snoho_parcelflood.csv', colClasses = c(rep('character',10), rep('numeric',5)))

##############################################################################################################
##----------------------------------- Examine and format data ------------------------------------------------
##############################################################################################################
#UNCOMMENT TO RE-ANALYZE
#Number of parcels that have intersections with multiple blocks
setkey(p_pred, 'PolyID')
parceldupli <- p_pred[PARCELPOP>0,][duplicated(p_pred[PARCELPOP>0,]),]
parceldupli_coded <- parceldupli[HOUSINGMIN>0 | TAXROLLNUM > 0, .(PolyID, HOUSINGMIN, #, StateLandUseCD
                                                                  TAXROLLNUM, PARCELPOP, HOUSINGADJ)]
##----------- Assess number of parcels and population with race/ethnicity predictions ------------------------
#Total number of parcel-blocks intersections
setDT(p_pred)

#Total number of parcel-blocks intersections kept in spatial parcel database
p_pred[!is.na(TAXROLLNUM),.N]
#Total number of parcels in spatial database
p_pred[!is.na(TAXROLLNUM), uniqueN(PolyID)]
#Total population in spatial parcel database
p_pred[PARCELPOP>0, sum(PARCELPOP)]
#Total population without a name prediction based on BISG
p_pred[(censusmod_sum==0 | is.na(censusmod_sum)) & PARCELPOP>0, sum(PARCELPOP)] #1,581,344
#Propotion of population predicted
p_pred[censusmod_sum>0,sum(PARCELPOP)]/p_pred[PARCELPOP>0, sum(PARCELPOP)]

#Total number of parcels with population
p_pred[PARCELPOP>0, .N]
p_pred[PARCELPOP>0, uniqueN(PolyID)]

#Total number of parcel-block intersections with population and a taxroll record
p_pred[PARCELPOP>0 & TAXROLLNUM>0, .N]

#Why TAXROLLNUM == 0?
notaxroll <- p_pred[PARCELPOP>0 & (TAXROLLNUM==0 | is.na(TAXROLLNUM)),]
notaxroll[, sum(PARCELPOP)]
#Because not in taxroll record in the first place (e.g. Cowlitz, Stevens, etc.) - see flood_risk_WA_format.py l349
countyname_notaxroll <- dataproviders[dataproviders$Abbreviation %in% c('Cowlitz', 'Lewis', 'Stevens', 'Jefferson', 'San Juan'),
                                      'DataProviderID']
county_notaxroll <- notaxroll[substr(PolyID,1,3) %in% countyname_notaxroll,] #parcels: 93,465
county_notaxroll[, sum(PARCELPOP)] #pop: 251,263

#Because not a residential land use and so was not included
#consider including by changing flood_risk_WA_format.py l353 to general taxroll database so as to include owner name
notaxroll[!(substr(PolyID,1,3) %in% countyname_notaxroll) & PolyID %in% parcel_taxrollname$PolyID, .N] #48,624
notaxroll[!(substr(PolyID,1,3) %in% countyname_notaxroll) & PolyID %in% parcel_taxrollname$PolyID, sum(PARCELPOP)]
#Because census block that does not intersect any parcel
notaxroll[PolyID == ' ', .N] #2,674 Not NA.. will be changed to 99900000000+
#Because 0 or NA StateLandUseCD + no land owner name associated with parcel
notaxroll_error <- notaxroll[!(substr(PolyID,1,3) %in% countyname_notaxroll) &
                               !(PolyID %in% parcel_taxrollname$PolyID) &
                               PolyID != ' ',]
#Because erroneously deleted when looking at duplicate PolyIDs in taxroll record? Correct, check again?

#Total population in a parcel with a taxroll but no name prediction (must be all those that had name which could not be analyzed)
parcel_taxrollnoname <- p_pred[(censusmod_sum==0 | is.na(censusmod_sum)) & PARCELPOP>0 & TAXROLLNUM>0,]

#Total population living in a parcel with taxroll record
p_pred[PARCELPOP>0 & TAXROLLNUM>0,sum(PARCELPOP)]

#Total number of parcel-block intersections with population, a taxroll record, and a name that could be analyzed
p_pred[PARCELPOP>0 & TAXROLLNUM>0 & !is.na(TaxRollIDCount), .N]

ggplot(p_predsub[abs(TAXROLLNUM-TaxRollIDCount)>0 & !is.na(TaxRollIDCount),],
       aes(x=TAXROLLNUM-TaxRollIDCount)) + geom_histogram() + scale_y_sqrt()
morenames <- p_predsub[(TAXROLLNUM-TaxRollIDCount)<0 & !is.na(TaxRollIDCount),]
#Not sure why some records have different number

#Population living in parcel with a name that could be analyzed
p_pred[PARCELPOP>0 & TAXROLLNUM>0 & !is.na(TaxRollIDCount), sum(PARCELPOP)]

#Average percentage of taxroll records per parcel that had a name to analyze for race/ethnicity prediction
p_pred[PARCELPOP>0 & TAXROLLNUM>0 & !is.na(TaxRollIDCount), 100*mean(TaxRollIDCount/TAXROLLNUM)]

#For each model, percentage of taxroll records and population that has name predictions
p_pred[PARCELPOP>0 & !is.na(white), c(.N, sum(PARCELPOP))]
p_pred[PARCELPOP>0 & !is.na(pctwhite), c(.N, sum(PARCELPOP))]
p_pred[PARCELPOP>0 & !is.na(GreaterEuropean.WestEuropean.French_wikiln), c(.N, sum(PARCELPOP))]
p_pred[PARCELPOP>0 & !is.na(GreaterEuropean.WestEuropean.French), c(.N, sum(PARCELPOP))]
p_pred[PARCELPOP>0 & !is.na(nh_white), c(.N, sum(PARCELPOP))]
p_pred[PARCELPOP>0 & !is.na(white_BISG), c(.N, sum(PARCELPOP))]

#------- Analysis of building dataset
#p_predsub_buildjoin <- p_predsub[buildattri, on='PolyID']

#------- Summary statistics by tract
#Percentage of parcels with name prediction per tract
t_namedat <- p_pred[, .(lastpred = 100*length(.I[!is.na(white)])/.N,
                        lastfirstpred = 100*length(.I[!is.na(nh_whitefl)])/.N,
                        census = 100*length(.I[!is.na(pctwhite)])/.N),
                    by=GEOID10_t]
#Percentage of population with name prediction per tract
t_namedatpop <- p_pred[PARCELPOP > 0, .(lastpred_pop = 100*sum(.SD[!is.na(white), PARCELPOP])/sum(.SD[,PARCELPOP]),
                                        lastfirstpred_pop = 100*sum(.SD[!is.na(nh_whitefl), PARCELPOP])/sum(.SD[,PARCELPOP]),
                                        census_pop = 100*sum(.SD[!is.na(pctwhite), PARCELPOP])/sum(.SD[,PARCELPOP])),
                       by=GEOID10_t]

racepopcdf <- ggplot(melt(t_namedatpop, id.vars='GEOID10_t'), aes(value)) +
  stat_ecdf(aes(color=variable), size=1.1, alpha=0.75) +
  #stat_ecdf(aes(y = 1 - ..y.., color=variable), stat='ecdf', size=1.3) +
  scale_x_reverse(name='Population with race data within tract (%)', limits=c(100,0), expand=c(0,0), breaks=seq(0,100,10)) +
  scale_y_continuous(name='Cumulative % of tracts', expand=c(0,0), breaks=seq(0,1,0.1)) +
  scale_color_manual(name= 'Race-name model type', values=c('#1b9e77','#d95f02','#7570b3'),
                     labels=c('Last name-only model', 'Last and first name model', 'Census model')) +
  theme_bw() +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        panel.grid.minor = element_blank())

#png(file.path(figdir, 'tract_racepopmod_cdf.png'), height=5, width=8, units = 'in', res=400)
racepopcdf
#dev.off()

t_namedatpop[,length(.I[lastpred_pop>70])/.N] #Percentage of census tracts with race data for > 70% of the population
t_namedatpop[,length(.I[lastpred_pop>0])/.N] #Percentage of census tracts with race data for > 0% of the population
t_namedatpop[,length(.I[lastpred_pop>0])] #Number of census tracts with race data

##############################################################################################################
##----------------------------------- Analyze results ------------------------------------------------
##############################################################################################################
#-------------------------------------------------------------------------
#Compare parcel aggregated population to blockgroup population estimates
ggplot(bg_pred, aes(x=B02001e1, y=PARCELPOP_)) + 
  geom_point() + 
  geom_smooth()
summary(lm(B02001e1~PARCELPOP_, data=bg_pred))

#Compare parcel-aggregated population to tract population
ggplot(t_pred, aes(x=DP0080001, y=PARCELPOP_)) + 
  geom_point() + 
  geom_smooth()
max(with(t_pred, abs(DP0080001-PARCELPOP_)), na.rm=T)

#Only keep census tracts for which have race data for >95% of population
t_pred <- setDT(t_pred)[t_namedatpop, on=c(GEOID10='GEOID10_t')]
t_predsub <- t_pred[lastpred_pop>90,]  
##----------------------------------- Analyze census tract data ------------------------------------------------
#Check predictions for white population
t_predsub[, `:=`(census_whiteper = DP0110011/DP0110001,
                 census_blackper = DP0110012/DP0110001,
                 census_hispper = DP0110002/DP0110001,
                 census_apiper = (DP0110014+DP0110015)/DP0110001,
                 census_otherper = (DP0110013+DP0110016+DP0110017)/DP0110001,
                 white_wikifull = Briti_wf + EastE_wf + Jewis_wf+ Frenc_wf + Germa_wf + Itali_wf + Nordi_wf,
                 white_wikiln = Briti_wln + EastE_wln + Jewis_wln+ Frenc_wln + Germa_wln + Itali_wln + Nordi_wln,
                 black_wikifull = Afric_wf + Musli_wf,
                 black_wikiln = Afric_wln + Musli_wln,
                 api_wikifull = EastA_wf + Japan_wf + India_wf,
                 api_wikiln = EastA_wln + Japan_wln + India_wln)
          ,]

gamplot <- function(dat, x, y, modname, lims=c(0,1)) {
  r2_label <- round(summary(mgcv::gam(formula(paste0(y,'~ s(',x,')')), data=dat))$dev.expl,2)
  # lims <- c(min(min(dat[,get(x)], na.rm=T), min(dat[,get(y)], na.rm=T)),
  #           max(max(dat[,get(x)], na.rm=T), max(dat[,get(y)], na.rm=T)))
  ggplot(dat, aes_string(x, y)) + 
    geom_point(alpha=0.75, color = '#68AAE1') + 
    geom_smooth(method='gam', formula=y ~ s(x, bs = "cs")) +
    geom_abline(slope=1, color='red') +
    annotate('text', x=c(lims[1], lims[1]), y=c(lims[2], lims[2]), 
             hjust = c(0,0), vjust = c(1,2.5), size=3.5, color='#385b78',
             label = c(paste0('Mean Error: ', 
                              round(100*mean(dat[,get(x)-get(y)], na.rm=T), 2),
                              '%'),
                       paste0('MAE: ', 
                              str_pad(
                                as.character(
                                  round(100*MAE(dat[,get(x)], dat[, get(y)], na.rm=T),2)),
                              width=4, side='right', pad='0'),
                              '%'))) +
    #ggtitle(bquote(paste(.(modname), ', ',R^2==~.(r2_label)))) + 
    coord_fixed(ratio=1) +
    scale_x_sqrt(limits= lims, expand=c(0,0)) +
    scale_y_sqrt(limits= lims, expand=c(0,0)) +
    #coord_trans(x='pow10', y='pow10') +
    theme_classic() +
    theme(plot.title = element_text(size=10, face = "bold"),
          axis.title = element_text(size=10),
          axis.text = element_text(size=10),
          plot.margin=unit(c(0.25,0.25,0.25,0.25),"cm"),
          plot.background = element_blank())
}

# whitecens <- gamplot(t_predsub, 'pctwhite', 'census_whiteper', 'Last name census probability distribution') +
#   labs(x = 'Predicted % of n.h. white residents', y= 'Reported % of n.h. white residents')
whitecensmod <- gamplot(t_predsub, 'white', 'census_whiteper', 'Last name census model', lims=c(0.25,1)) +
  labs(title='Census surname-only model',
       x = 'Predicted % of n.h. white residents', y= 'Reported % of n.h. white residents')
# whitewikiln <- gamplot(t_predsub, 'white_wikiln', 'census_whiteper', 'Last name wikipedia model') +
#   labs(x = 'Predicted % of n.h. white residents', y= 'Reported % of n.h. white residents')
whitewikifull <- gamplot(t_predsub, 'white_wikifull', 'census_whiteper', 'Full name wikipedia model', lims=c(0.25,1)) +
  labs(title='Wikipedia full name model',
       x = 'Predicted % of n.h. white residents', y= 'Reported % of n.h. white residents')
whiteflreg <- gamplot(t_predsub, 'nh_whitefl', 'census_whiteper', 'Full name Florida registration model', lims=c(0.25,1)) +
  labs(title='Florida voters full name model',
       x = 'Predicted % of n.h. white residents', y= 'Reported % of n.h. white residents')
whiteBISG <- gamplot(t_predsub, 'white_BISG', 'census_whiteper', 'BISG last name + geocoding model', lims=c(0.25,1)) +
  labs(title='BISG model',
       x = 'Predicted % of n.h. white residents', y= 'Reported % of n.h. white residents')
png('parcel_tract_racecomparison_o90_nhwhite.png', width=6, height=6, units='in', res=400)
grid.arrange(whitecensmod, whitewikifull, whiteflreg, whiteBISG)
dev.off()

# blackcens <- gamplot(t_predsub, 'pctblack', 'census_blackper', 'Last name census probability distribution') +
#   labs(x = 'Predicted % of n.h. black residents', y= 'Reported % of n.h. black residents')
blackcensmod <- gamplot(t_predsub, 'black', 'census_blackper', 'Last name census model', lims=c(0,0.5)) +
  labs(title='Census surname-only model',
       x = 'Predicted % of n.h. black residents', y= 'Reported % of n.h. black residents')
# blackwikiln <- gamplot(t_predsub, 'black_wikiln' , 'census_blackper', 'Last name wikipedia model') +
#   labs(x = 'Predicted % of n.h. black residents', y= 'Reported % of n.h. black residents')
blackwikifull <- gamplot(t_predsub, 'black_wikifull', 'census_blackper', 'Full name wikipedia model', lims=c(0,0.5)) +
  labs(title='Wikipedia full name model',
       x = 'Predicted % of n.h. black residents', y= 'Reported % of n.h. black residents')
blackflreg <- gamplot(t_predsub, 'nh_blackfl', 'census_blackper', 'Full name Florida registration model', lims=c(0,0.5)) +
  labs(title='Florida voters full name model',
       x = 'Predicted % of n.h. black residents', y= 'Reported % of n.h. black residents')
blackBISG <- gamplot(t_predsub, 'black_BISG', 'census_blackper', 'BISG last name + geocoding model', lims=c(0,0.5)) +
  labs(title='BISG model',
       x = 'Predicted % of n.h. black residents', y= 'Reported % of n.h. black residents')
png('parcel_tract_racecomparison_o90_nhblack.png', width=6, height=6, units='in', res=400)
grid.arrange(blackcensmod, blackwikifull, blackflreg, blackBISG)
dev.off()

# hispcens <- gamplot(t_predsub, 'pcthispani', 'census_hispper', 'Last name census probability distribution') +
#   labs(x = 'Predicted % of hispanic residents', y= 'Reported % of hispanic residents')
hispcensmod <- gamplot(t_predsub, 'hispanic', 'census_hispper', 'Last name census model') +
  labs(title='Census surname-only model',
       x = 'Predicted % of hispanic residents', y= 'Reported % of hispanic residents')
# hispwikiln <- gamplot(t_predsub, 'Hispa_wf' , 'census_hispper', 'Last name wikipedia model') +
#   labs(x = 'Predicted % of hispanic residents', y= 'Reported % of hispanic residents')
hispwikifull <- gamplot(t_predsub, 'Hispa_wln', 'census_hispper', 'Full name wikipedia model') +
  labs(title='Wikipedia full name model',
       x = 'Predicted % of hispanic residents', y= 'Reported % of hispanic residents')
hispflreg <- gamplot(t_predsub, 'hispanicfl', 'census_hispper', 'Full name Florida registration model') +
  labs(title='Florida voters full name model',
       x = 'Predicted % of hispanic residents', y= 'Reported % of hispanic residents')
hispBISG <- gamplot(t_predsub, 'hisp_BISG', 'census_hispper', 'BISG last name + geocoding model') +
  labs(title='BISG model',
       x = 'Predicted % of hispanic residents', y= 'Reported % of hispanic residents')
png('parcel_tract_racecomparison_o90_nhhispanic.png', width=6, height=6, units='in', res=400)
grid.arrange(hispcensmod, hispwikifull, hispflreg, hispBISG)
dev.off()
#The outlier in BISG model is due to a property with 171 people assigned to 99% hispanic in model and biasing whole tract

t_predsub

# apicens <- gamplot(t_predsub, 'pctapi', 'census_apiper', 'Last name census probability distribution') +
#   labs(x = 'Predicted % of n.h. API residents', y= 'Reported % of n.h. API residents')
apicensmod <- gamplot(t_predsub, 'api', 'census_apiper', 'Last name census model') +
  labs(title='Census surname-only model',
       x = 'Predicted % of n.h. API residents', y= 'Reported % of n.h. API residents')
# apiwikiln <- gamplot(t_predsub, 'api_wikiln' , 'census_apiper', 'Last name wikipedia model') +
#   labs(x = 'Predicted % of n.h. API residents', y= 'Reported % of n.h. API residents')
apiwikifull <- gamplot(t_predsub, 'api_wikifull', 'census_apiper', 'Full name wikipedia model') +
  labs(title='Wikipedia full name model',
       x = 'Predicted % of n.h. API residents', y= 'Reported % of n.h. API residents')
apiflreg <- gamplot(t_predsub, 'asianfl', 'census_apiper', 'Full name Florida registration model') +
  labs(title='Florida voters full name model',
       x = 'Predicted % of n.h. API residents', y= 'Reported % of n.h. API residents') 
apiBISG <- gamplot(t_predsub, 'asi_BISG', 'census_apiper', 'BISG last name + geocoding model') +
  labs(title='BISG model',
       x = 'Predicted % of n.h. API residents', y= 'Reported % of n.h. API residents')
png('parcel_tract_racecomparison_o90_nhapi.png', width=6, height=6, units='in', res=400)
grid.arrange(apicensmod, apiwikifull, apiflreg, apiBISG)
dev.off()


otherBISG <- gamplot(t_predsub, 'oth_BISG', 'census_otherper', 'BISG last name + geocoding model', lims=c(0,0.30)) +
  labs(title='BISG model',
       x = 'Predicted % of n.h. other residents', y= 'Reported % of n.h. other residents')
png('parcel_tract_racecomparison_o90_nhother.png', width=3, height=3, units='in', res=400)
otherBISG
dev.off()

png('parcel_tract_racecomparison_o90.png', width=20, height=14, units='in', res=400)
grid.arrange(apiBISG, blackBISG, hispBISG, whiteBISG)
dev.off()


res <- residuals.gam(mgcv::gam(census_whiteper~white_BISG, data=t_predsub))
mean(abs(res))
qplot(res)
qqnorm(res)
qqline(res)


#Check influence of rental rates on errors
t_predsub <- t_predsub[t_attri[, .(GEOID10, DP0210003,DP0210001)], on='GEOID10']
t_predsub[DP0210001>0, perc_renters := DP0210003/DP0210001]
asi_rent <- ggplot(t_predsub, aes(x=perc_renters, y=asi_BISG-census_apiper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3)+ 
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  scale_x_continuous(limits=c(0,0.5), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  #geom_smooth() +
  labs(x='% units occupied by renters', y='Error - % n.h. API residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text=element_text(size=10))

black_rent <- ggplot(t_predsub, aes(x=perc_renters, y=black_BISG-census_blackper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3) + 
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  scale_x_continuous(limits=c(0,0.5), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  #geom_smooth() +
  labs(x='% units occupied by renters', y='Error - % n.h. black residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text=element_text(size=10))

hisp_rent <- ggplot(t_predsub, aes(x=perc_renters, y=hisp_BISG-census_hispper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3) + 
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  scale_x_continuous(limits=c(0,0.5), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  #geom_smooth() +
  labs(x='% units occupied by renters', y='Error - % hispanic residents') +
  theme_classic()+
  theme(legend.position = c(0.25, 0.75),
        legend.background = element_rect(fill = alpha('white', 0.75)),
        text= element_text(size=10))

white_rent <- ggplot(t_predsub, aes(x=perc_renters, y=white_BISG-census_whiteper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3) + 
  guides(size=guide_legend(title = "# of residents in tract")) +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  scale_x_continuous(limits=c(0,0.5), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  #geom_smooth() +
  labs(x='% units occupied by renters', y='Error - % n.h. white residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text=element_text(size=10))

png('parcel_tract_racecomparison_o90_renters.png', width=6, height=6, units='in', res=400)
grid.arrange(asi_rent, black_rent, hisp_rent, white_rent)
dev.off()
  
#Check influence of the presence of large individual units
t_predsub <- t_predsub[p_pred[, list(maxunitper = max(PARCELPOP)/sum(PARCELPOP)), by=GEOID10_t], on='GEOID10_t']
asi_errormaxu <- ggplot(t_predsub, aes(x=maxunitper, y=asi_BISG-census_apiper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3)+ 
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  scale_x_sqrt(limits=c(0,0.2), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  labs(x='max unit size/total tract population', y='Error - % n.h. API residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text= element_text(size=10))

black_errormaxu <- ggplot(t_predsub, aes(x=maxunitper, y=black_BISG-census_blackper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3)+ 
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  scale_x_sqrt(limits=c(0,0.2), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  labs(x='max unit size/total tract population', y='Error - % n.h. black residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text=element_text(size=10))

hisp_errormaxu <- ggplot(t_predsub, aes(x=maxunitper, y=hisp_BISG-census_hispper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3)+ 
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  scale_x_sqrt(limits=c(0,0.2), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  labs(x='max unit size/total tract population', y='Error - % n.h. hispanic residents') +
  theme_classic()+
  theme(legend.position = c(0.25, 0.75),
        legend.background = element_rect(fill = alpha('white', 0.75)),
        text= element_text(size=10))

white_errormaxu <- ggplot(t_predsub, aes(x=maxunitper, y=white_BISG-census_whiteper)) + 
  geom_point(aes(size=PARCELPOP_), alpha=1/3)+ 
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='darkorange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  scale_x_sqrt(limits=c(0,0.2), expand=c(0,0)) +
  coord_cartesian(clip='off') +
  labs(x='max unit size/total tract population', y='Error - % n.h. white residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text=element_text(size=10))
png('parcel_tract_racecomparison_o90_maxu.png', width=6, height=6, units='in', res=400)
grid.arrange(asi_errormaxu, black_errormaxu, hisp_errormaxu, white_errormaxu)
dev.off()

mod <- lm(abs(white_BISG-census_whiteper)~maxunitper+PARCELPOP_+perc_renters, data=t_predsub)
summary(mod)
mod <- lm(abs(black_BISG-census_blackper)~maxunitper+PARCELPOP_+perc_renters, data=t_predsub)
summary(mod)
mod <- lm(abs(hisp_BISG-census_hispper)~maxunitper+PARCELPOP_+perc_renters, data=t_predsub)
summary(mod)
mod <- lm(abs(asi_BISG-census_apiper)~maxunitper+PARCELPOP_+perc_renters, data=t_predsub)
summary(mod)

#Check influence of pop size
asi_errorpop <- ggplot(t_predsub, aes(x=PARCELPOP_, y=abs(asi_BISG-census_apiper))) + 
  geom_point() +
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='orange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  labs(x='# of residents', y='predicted - observed % of n.h. API residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text= element_text(size=20))

black_errorpop <- ggplot(t_predsub, aes(x=PARCELPOP_, y=abs(black_BISG-census_blackper))) + 
  geom_point() +
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='orange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  labs(x='# of residents', y='predicted - observed % of n.h. black residents') +
  theme_classic() +
  theme(legend.position = 'none',
        text=element_text(size=20))

hisp_errorpop <- ggplot(t_predsub, aes(x=PARCELPOP_, y=abs(hisp_BISG-census_hispper))) + 
  geom_point() +
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='orange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  labs(x='# of residents', y='predicted - observed % of hispanic residents') +
  theme_classic()+
  theme(legend.position = 'none',
        text= element_text(size=20))

white_errorpop <- ggplot(t_predsub, aes(x=PARCELPOP_, y=abs(white_BISG-census_whiteper))) + 
  geom_point() +
  guides(size=guide_legend(title = "# of residents in tract")) +
  geom_quantile(quantiles=c(0.05, 0.25, 0.5, 0.75, 0.95), color='orange') +
  geom_abline(slope=0, intercept=0, linetype = 2) +
  labs(x='# of residents', y='predicted - observed % of n.h. black residents') +
  theme_classic() +
  theme(legend.position = c(0.20, 0.23),
        legend.background = element_rect(fill = alpha('white', 0.75)),
        text=element_text(size=20))
grid.arrange(asi_errorpop, black_errorpop, hisp_errorpop, white_errorpop)

#Gauge how much it adds up to in terms of misclassified individuals
summary(t_predsub[,(PARCELPOP_*(white_BISG-census_whiteper))/(census_whiteper*PARCELPOP_)])
sum(t_predsub[,PARCELPOP_*(white_BISG-census_whiteper)], na.rm=T)



