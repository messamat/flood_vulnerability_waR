library(feather)
library(data.table)
library(wru)

source('key.R')
if (grepl('results', getwd())) {
  rootdir =  "C:/Mathis/ICSL/flood_vulnerability"
} else{
  rootdir = gsub("/src.*","",getwd())
}
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
setwd(resdir)

#----------------------------------- Import data ------------------------------------------------
#Parcel owner names
residindiv_filter <- read_feather('residindiv_filter.feather')
#Parcel-level race/ethnicity predictions - all models
parcel_pred <- read_feather('parcels_blocksfill_racepred.feather')
parcel_predsub <- setDT(parcel_pred)[PARCELPOP>0 & !is.na(PARCELPOP),]

#Join parcel owner names with geographic information to predict race with BISG/wru
#But remove duplicate owner names (when parcels are assigned to two different blocks)
residindiv_filterjoin <- setDT(residindiv_filter)[
  parcel_predsub[BLCKMAJ==1,c('PARCELPOP','BLOCKID10','PolyID')], on='PolyID']
residindiv_filterjoin <- residindiv_filterjoin[order(residindiv_filterjoin$TaxRollID, 
                                                     -abs(residindiv_filterjoin$PARCELPOP)),]
residindiv_filter_nodupli <- residindiv_filterjoin[!duplicated(residindiv_filterjoin$TaxRollID),]
#Format data for wru predictions
residindiv_filter_nodupli[,`:=`(state = 'WA', 
                                county = substr(BLOCKID10, 3, 6),
                                tract = substr(BLOCKID10, 7, 12),
                                block = substr(BLOCKID10, 13, 17))]
setnames(residindiv_filter_nodupli, old="party1_last1", new="surname")

#Predict race with BISG/wru
predict_race(voter.file = residindiv_filter_nodupli, census.geo = "tract", census.key = apikey)




