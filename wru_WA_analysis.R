library(feather)
library(foreign)
library(data.table)
library(wru)

source('key.R')
if (grepl('results', getwd())) {
  rootdir =  "C:/Mathis/ICSL/flood_vulnerability"
} else{
  rootdir = gsub("/src.*","",getwd())
}
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
setwd(resdir)

#----------------------------------- Import data ------------------------------------------------
#Parcel owner names
residindiv_filter <- read_feather('residindiv_filter.feather')
#Parcel-level race/ethnicity predictions - all models
parcel_ethnicolrpred <- read_feather('parcels_blocksfill_ethnicolrpred.feather')
parcel_ethnicolrpredsub <- setDT(parcel_ethnicolrpred)[PARCELPOP>0 & !is.na(PARCELPOP),]

#Join parcel owner names with geographic information to predict race with BISG/wru
#But remove duplicate owner names (when parcels are assigned to two different blocks)
residindiv_filterjoin <- setDT(residindiv_filter)[
  parcel_ethnicolrpredsub[,c('PARCELPOP','BLOCKID10','GEOID10_t','PolyID')], on='PolyID']
residindiv_filterjoin <- residindiv_filterjoin[order(residindiv_filterjoin$TaxRollID, 
                                                     -abs(residindiv_filterjoin$PARCELPOP)),]
residindiv_filter_nodupli <- residindiv_filterjoin[!duplicated(residindiv_filterjoin$TaxRollID),]
#Format data for wru predictions
residindiv_filter_nodupli[,`:=`(state = 'WA', 
                                county = substr(BLOCKID10, 3, 5),
                                tract = substr(BLOCKID10, 6, 11),
                                block = substr(BLOCKID10, 12, 15))]
setnames(residindiv_filter_nodupli, old="party1_last1", new="surname")

#Predict race with BISG/wru
censusdata <- get_census_data(key = apikey, state = "WA", age = FALSE, sex = FALSE)  # create Census data object covering DC and NJ 
BISGpred <- predict_race(voter.file = residindiv_filter_nodupli, census.geo = "block", census.data = censusdata)

#Compute average race probability distribution by parcel 
parcel_BISGpred <- setDT(BISGpred)[,`:=`(white_BISG = mean(pred.whi, na.rm=T), 
                                         black_BISG = mean(pred.bla, na.rm=T),
                                         hisp_BISG = mean(pred.his, na.rm=T),
                                         asi_BISG = mean(pred.asi, na.rm=T),
                                         oth_BISG = mean(pred.oth, na.rm=T)), 
                                   by = 'PolyID'][!duplicated(BISGpred$PolyID)]

parcel_pred <- parcel_ethnicolrpredsub[
                  parcel_BISGpred[,c("PolyID", grep('BISG$', colnames(parcel_BISGpred), value=T)),with=F],
                  on='PolyID']
write.dbf(parcel_pred, 'parcels_blocksfill_racepred.dbf')

#Compute weighted average race probability distribution by tract based on population
tract_BISGpred <- setDT(BISGpred)[,.(white_BISG = weighted.mean(pred.whi, PARCELPOP, na.rm = T),
                                     black_BISG = weighted.mean(pred.bla, PARCELPOP, na.rm = T),
                                     hisp_BISG = weighted.mean(pred.his, PARCELPOP, na.rm = T),
                                     asi_BISG = weighted.mean(pred.asi, PARCELPOP, na.rm = T),
                                     oth_BISG = weighted.mean(pred.oth, PARCELPOP, na.rm = T)), 
                                   by = 'GEOID10_t']
write_feather(tract_BISGpred, 'tract_BISGpred.feather')