# Author: Mathis L. Messager
# Affiliation: School of Environmental and Forest Sciences, University of Washington
# Contact info: messamat@uw.edu
# Date created: October 2019
# 
# Purpose: Predicts race/ethnicity for all parcels with private individual owner names in Washington State based on
# race-name models developed by Imai & Khanna (2018).

# To get census API key, visit: https://api.census.gov/data/key_signup.html

library(feather)
library(fst)
library(foreign)
library(data.table)
library(wru)
library(rprojroot)

rootdir <- find_root(has_dir("src"))
datadir = file.path(rootdir, 'data')
resdir = file.path(rootdir, 'results')
figdir = file.path(resdir, 'figures')
setwd(resdir)

#----------------------------------- Import data ------------------------------------------------
#Parcel owner names
residindiv_filter <- read_feather('residindiv_filter.feather')
#Parcel-level race/ethnicity predictions - all models
parcel_ethnicolrpred <- read_feather('parcels_blocksfill_ethnicolrpred.feather')
parcel_ethnicolrpredsub <- setDT(parcel_ethnicolrpred)[PARCELPOP>0 & !is.na(PARCELPOP),]

#Join parcel owner names with geographic information to predict race with BISG/wru
residindiv_filterjoin <- setDT(residindiv_filter)[
  parcel_ethnicolrpredsub[,c('PARCELPOP','BLOCKID10','GEOID10_t','PolyID')], on='PolyID']
residindiv_filterjoin <- residindiv_filterjoin[order(residindiv_filterjoin$PolyID, 
                                                     -abs(residindiv_filterjoin$PARCELPOP)),]

#Format data for wru predictions
residindiv_filterjoin[,`:=`(state = 'WA', 
                                county = substr(BLOCKID10, 3, 5),
                                tract = substr(BLOCKID10, 6, 11),
                                block = substr(BLOCKID10, 12, 15))]
setnames(residindiv_filterjoin, old="party1_last1", new="surname")

#Predict race with BISG/wru
if (!(file.exists('BISG_censusdata_WA'))) {
  censusdata <- get_census_data(key = apikey, state = "WA", age = FALSE, sex = FALSE)  # create Census data object covering DC and NJ 
  save(censusdata, file = "BISG_censusdata_WA")
} else {
  load("BISG_censusdata_WA")
}

names(censusdata$WA$block)[grep('P0050.*', names(censusdata$WA$block))] <- 
  gsub('(?<=P0050)0', '', grep('P0050.*', names(censusdata$WA$block), value=T), perl=TRUE)

BISGpred <- predict_race(voter.file = as.data.frame(residindiv_filterjoin), 
                         census.geo = "block", census.data = censusdata) 


#Assign NaN when model assigns probability of belonging to race based on census block-only
setDT(BISGpred)[is.na(surname), `:=`(pred.whi=NaN, pred.bla=NaN, pred.his=NaN, pred.asi=NaN, pred.oth=NaN)] 

#Compute average race probability distribution by parcel 
parcel_BISGpred <- setDT(BISGpred)[,`:=`(white_BISG = mean(pred.whi, na.rm=T), 
                                         black_BISG = mean(pred.bla, na.rm=T),
                                         hisp_BISG = mean(pred.his, na.rm=T),
                                         asi_BISG = mean(pred.asi, na.rm=T),
                                         oth_BISG = mean(pred.oth, na.rm=T)), 
                                   by = 'PolyID'][!duplicated(BISGpred$PolyID)]

parcel_pred <- parcel_ethnicolrpredsub[
  parcel_BISGpred[,c("PolyID", "surname", grep('BISG$', colnames(parcel_BISGpred), value=T)),with=F],
  on='PolyID']

#Check records that BISG model wasn't able to predict but census model was and impute them
NAproblem <- setDT(parcel_pred)[!is.na(white) & is.na(white_BISG),] #Only 119 TaxRollID that the model wasn't able to predict
setDT(parcel_pred)[!is.na(parcel_pred$white) & is.na(parcel_pred$white_BISG), `:=`(white_BISG = white, 
                                                                                   black_BISG = black,
                                                                                   hisp_BISG = hispanic,
                                                                                   asi_BISG = api)]

#Write output
write.fst(parcel_pred, 'parcels_blocksfill_racepred.fst')

if (file.exists('parcels_blocksfill_racepred.dbf')){
  print('Delete table')
  file.remove('parcels_blocksfill_racepred.dbf')
}
write.dbf(parcel_pred, 'parcels_blocksfill_racepred.dbf')

#Compute weighted average race probability distribution by tract based on population
tract_BISGpred <- setDT(BISGpred)[,.(white_BISG = weighted.mean(pred.whi, PARCELPOP, na.rm = T),
                                     black_BISG = weighted.mean(pred.bla, PARCELPOP, na.rm = T),
                                     hisp_BISG = weighted.mean(pred.his, PARCELPOP, na.rm = T),
                                     asi_BISG = weighted.mean(pred.asi, PARCELPOP, na.rm = T),
                                     oth_BISG = weighted.mean(pred.oth, PARCELPOP, na.rm = T)), 
                                   by = 'GEOID10_t']
write_feather(tract_BISGpred, 'tract_BISGpred.feather')